@page "/order"
@layout OrdersLayout
@inject OrderHandlerService orderHandler;
@inject CandleHandlerService candleHandler;
@inject NavigationManager navManager;

<h3>Orders</h3>

<div class="nav-item px-3">
	<NavLink class="nav-link" href="new-order">
		<span class="oi oi-list-rich" aria-hidden="true"></span> Додати замовлення
	</NavLink>
</div>

<table class="table">
	<thead>
		<tr>
			<th>Id</th>
			<th>Дата</th>
			<th>ПІБ</th>
			<th>Номер телефону</th>
			<th>Місто</th>
			<th>Адреса доставки</th>
			<th>Свічка</th>
			<th>Кількість</th>
			<th>Сума</th>
			<th>Промокод</th>
			<th>Коментар</th>
		</tr>
	</thead>
	<tbody>
		@foreach(var order in OrdersList)
		{
			<tr>
				<td>@order.Id</td>
				<td>@order.OrderDate</td>
				<td>@order.Receiver.FullName</td>
				<td>@order.Receiver.PhoneNumber</td>
				<td>@order.Receiver.City</td>
				<td>@order.Receiver.DeliveryAdress</td>
				<td>
					@foreach(var detail in order.OrderDetails)
					{
						@candleNames.FirstOrDefault(c => c.Id == detail.CandleId)?.Name
					}
				</td>
				<td>
					@foreach(var detail in order.OrderDetails)
					{
						@detail.CandleQuantity
					}
				</td>
				<td>@order.TotalSum</td>
				<td>@order.Promocode</td>
				<td>@order.Comments</td>
				<td><button type="button" @onclick="() => EditOrder(order.Id)">Edit</button></td>
			</tr>
		}
	</tbody>
</table>

@OrdersExistMessage

@code {
	public IEnumerable<OrderVM> OrdersList { get; set; } = new List<OrderVM>();

	public string OrdersExistMessage { get; set; } = "Loading...";

	private IEnumerable<CandleFullVM> candleNames { get; set; } = new List<CandleFullVM>();

	protected override async Task OnInitializedAsync()
	{
		candleNames = await candleHandler.GetAllCandlesListAsync("api/candle?view=full");

		OrdersList = await orderHandler.GetAllOrdesListAsync("api/order");
		OrdersList = OrdersList.OrderByDescending(o => o.Id);
		OrdersExistMessage = OrdersList.Any() switch
		{
			true => "",
			_ => "Сталась помилка або замовлення відсутні"
		};
	}

	public void EditOrder(int orderId)
	{
		navManager.NavigateTo($"order/{orderId}");
	}
}
